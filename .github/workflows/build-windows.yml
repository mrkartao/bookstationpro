name: Build Windows Installer

on:
  push:
    branches: [ "main" ]
    tags: [ 'v*.*.*' ]
  workflow_dispatch: {}

jobs:
  build-windows:
    name: Build NSIS installer (Windows ${{ matrix.arch }})
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [ x64, ia32 ]
        node-version: [ 20 ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
          key: node-modules-${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: node-modules-${{ runner.os }}-node-${{ matrix.node-version }}-

      - name: Install dependencies
        run: npm ci

      - name: Check code signing secret presence (secure)
        if: always()
        shell: pwsh
        env:
          CSC_BASE64: ${{ secrets.CSC_BASE64 }}
        run: |
          if (![string]::IsNullOrEmpty($env:CSC_BASE64)) {
            Write-Host "CSC_BASE64: PRESENT (value hidden)"
          } else {
            Write-Host "CSC_BASE64: NOT PROVIDED"
          }

      - name: Prepare code signing file (optional)
        if: always()
        shell: pwsh
        env:
          CSC_BASE64: ${{ secrets.CSC_BASE64 }}
        run: |
          if (![string]::IsNullOrEmpty($env:CSC_BASE64)) {
            Write-Host "Decoding CSC_BASE64 to codesign.p12"
            [IO.File]::WriteAllBytes('codesign.p12', [Convert]::FromBase64String($env:CSC_BASE64))
            Write-Host "codesign.p12 created"
          } else {
            Write-Host "CSC_BASE64 not provided — skipping p12 creation."
          }

      - name: Build installer for ${{ matrix.arch }}
        env:
          ARCH: ${{ matrix.arch }}
          # Optional code signing secrets. If you add these secrets in the repository
          # settings, electron-builder will sign the produced installer.
          CSC_BASE64: ${{ secrets.CSC_BASE64 }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          if ($env:ARCH -eq 'x64') { npm run build:win64 } else { npm run build:win32 }

      - name: Cleanup code signing file (optional)
        if: always()
        shell: pwsh
        run: |
          if (Test-Path -Path .\codesign.p12) {
            Write-Host "Removing codesign.p12"
            Remove-Item -Path .\codesign.p12 -Force
          } else {
            Write-Host "codesign.p12 not found — nothing to remove."
          }

      - name: List release files
        run: dir .\release\ -Force

      - name: Prepare artifacts and compress (include tag in names)
        if: always()
        shell: pwsh
        env:
          ARCH: ${{ matrix.arch }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          if (Test-Path -Path .\release) {
            $tag = $env:TAG_NAME
            if ([string]::IsNullOrEmpty($tag)) { $tag = "dev-$($env:GITHUB_RUN_ID)" }
            Write-Host "Using tag: $tag"

            # Prepare artifacts directory
            New-Item -ItemType Directory -Path .\artifacts -Force | Out-Null

            # Copy and rename .exe files to the desired format: Station Pro-Setup-<tag>-<arch>.exe
            Get-ChildItem -Path .\release\*.exe -ErrorAction SilentlyContinue | ForEach-Object {
              $ext = $_.Extension
              $new = "Station Pro-Setup-$tag-$($env:ARCH)$ext"
              Copy-Item $_.FullName -Destination (Join-Path .\artifacts $new) -Force
            }

            # Copy remaining release files into artifacts (preserve structure)
            Get-ChildItem -Path .\release -Recurse | ForEach-Object {
              $relative = $_.FullName.Substring((Get-Item .\release).FullName.Length).TrimStart('\')
              $dest = Join-Path .\artifacts $relative
              if ($_.PSIsContainer) {
                New-Item -ItemType Directory -Path $dest -Force | Out-Null
              } else {
                Copy-Item $_.FullName -Destination $dest -Force
              }
            }

            $zipName = "Station Pro-Setup-$tag-$($env:ARCH).zip"
            $zipPath = Join-Path (Get-Location) (Join-Path '.\artifacts' $zipName)
            Write-Host "Creating $zipPath from .\artifacts\"
            Remove-Item -Force -ErrorAction SilentlyContinue $zipPath
            Compress-Archive -Path .\artifacts\* -DestinationPath $zipPath -Force
            Write-Host "$zipPath created"
          } else {
            Write-Host "Release folder not found — skipping artifacts preparation."
          }

      - name: Upload release artifacts (folder)
        uses: actions/upload-artifact@v4
        with:
          name: Book-Station-Pro-${{ matrix.arch }}-files
          path: artifacts/**

      - name: Upload release ZIP
        uses: actions/upload-artifact@v4
        with:
          name: Book-Station-Pro-${{ matrix.arch }}-zip
          path: artifacts/Station Pro-Setup-${{ github.ref_name }}-${{ matrix.arch }}.zip

      - name: Publish artifacts to GitHub Release (when building from a tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          # the action will default tag_name to the current tag (github.ref_name)
          # Attach the ZIP and any .exe installers from artifacts/ (renamed to include the tag)
          files: |
            artifacts/Station Pro-Setup-${{ github.ref_name }}-${{ matrix.arch }}.zip
            artifacts/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}